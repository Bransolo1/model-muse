name: Sensehub CI

on:
  push:
    branches: [main]
    paths:
      - 'shiny-app/**'
  pull_request:
    branches: [main]
    paths:
      - 'shiny-app/**'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: shiny-app

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'
          use-public-rspm: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('shiny-app/renv.lock') }}
          restore-keys: ${{ runner.os }}-r-

      - name: Install renv and restore
        run: |
          install.packages("renv")
          if (file.exists("renv.lock")) {
            renv::restore()
          } else {
            install.packages(c(
              "testthat", "lintr",
              "shiny", "bslib", "DT", "shinyWidgets", "shinyjs",
              "tidymodels", "recipes", "parsnip", "workflows", "workflowsets",
              "tune", "rsample", "yardstick", "dials", "stacks", "probably",
              "glmnet", "ranger", "xgboost", "kknn", "kernlab", "discrim", "naivebayes", "rpart",
              "promises", "future", "parallelly",
              "dplyr", "tidyr", "purrr", "readr", "forcats", "readxl", "lubridate",
              "ggplot2", "jsonlite", "tibble", "rlang", "vip", "themis"
            ))
          }
        shell: Rscript {0}

      - name: Lint
        run: |
          library(lintr)
          lints <- lint_dir("R/", linters = linters_with_defaults(
            line_length_linter(240),
            object_name_linter = NULL,
            commented_code_linter = NULL
          ))
          if (length(lints) > 0) {
            print(lints)
            cat(sprintf("\nâš  %d lint issues found.\n", length(lints)))
            quit(status = 1)
          }
        shell: Rscript {0}

      - name: Run unit tests
        run: |
          library(testthat)
          source("R/config.R")
          source("R/utils_logging.R")
          source("R/utils_validation.R")
          source("R/modeling.R")
          source("R/export.R")
          results <- test_dir("tests/", reporter = "summary")
          if (any(as.data.frame(results)$failed > 0)) {
            stop("Tests failed!")
          }
        shell: Rscript {0}
